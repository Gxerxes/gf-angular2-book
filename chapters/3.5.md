#### 9.5 组件开发 （20000字）

本节依据组件树和定义好的数据结构，以功能模块为分类，阐述组件的开发过程。

##### 9.5.1 管理后台

在具体实施组件开发之前，先简单介绍下json-server管理后台，前后台通过数据结构和调用接口无缝的连接起来。（这里给出后台初始化代码，在每个组件开发中需要使用后台部分，我们将逐渐完善后台代码）

##### 9.5.2 主页面和帮助说明

- 根组件：页面启动（bootstrap），路由（route），服务调用（http），全局provider
- 首页和帮助说明组件：导航栏，轮询功能

##### 9.5.3 用户管理

在 2.3 章节已经介绍了对表单的处理，在这部分用注册来示例一个完整的表单。收集用户填写的信息，并对用户输入内容的校验，是表单的最基础的功能，示例中包含：

+ 事件绑定和数据绑定，通过小括号 `(event)` 来定义一个事件，通过两个大括号 `{{name}}` 定义一个数据的单向绑定，具体可参考显示密码功能；
+ 通过 `ngModel` 指令做数据的双向绑定
+ 通过 `ngForm` 定义一个 `form`
+ 通过 `ngControl` 做自定义表单校验

##### 9.5.4 创建/编辑问卷

- 问题组件：四类问题组件，引入类继承的概念。首先，定义问题组件的基类，说明每个属性的含义。然后针对不同类别的问题组件定义子类的属性。
- 问卷组件：讲解问卷组件的代码，重点介绍问卷的状态管理，同时完善后台代码中的问卷部分。
- 问卷大纲组件：讲解问卷大纲组件的代码。

##### 9.5.4 创建问卷

创建问卷是整个问卷调查系统最核心的功能之一。该功能共有三大类组件构成，分别为问题组件、问卷组件和问卷大纲组件，接下来将逐一实现这三大类组件。

###### 问题组件

问题组件是构建问卷组件的基础。几乎所有类型的问题组件都会包括问题标题、问题答案和控件状态等属性，以及编辑、取消编辑、保存和删除等操作，本例中这样公共部分将被封装到一个父类中，具体类型的问题组件将继承自该父类。父类的定义如下：

	export class QuestionComponent implements OnInit {
		question:QuestionModel;
		newQuestion:QuestionModel;
		isEdit:boolean = false;
		isPublished:boolean = false;
		delQuesitonRequest: EventEmitter<any> = new EventEmitter();

		constructor() {}

		toEdit() {
			this.isEdit = true;
		}

		toSave() {
			this.question = this.newQuestion;
			this.isEdit = false;
		}

		toDelete() {
			this.delQuestionRequest.emit(this.question);
		}

		toCancel() {
			this.newQuestion = this.question;
			this.isEdit = false;
		}

		ngOnInit(): void {
			this.question == null ? this.isEdit = true :
				this.newQuestion = this.question;
		}
	}

在上面的问题组件类定义中，question和newQuestion分别代表编辑前和编辑后的问题。isEdit标记问题当前是否处于编辑状态，isPublished标记问题是否处于已发布状态。

需要的特别注意的是delQuestionRequest属性，它的类型是EventEmitter。删除一个问题，需要经过如下步骤：

1. 问题组件中触发删除操作(toDelete方法)
2. 删除事件由问题组件（子组件）传递给所对应的问卷组件（父组件）
3. 在问卷组件的维护的问题列表中将该问题删除

通过delQuestionRequest属性就可以起到在父组件中监听子组件事件的作用（参见2.4.2小节）。

除了问题组件类属性之外，我们还定义了几个组件类似编辑、保存、取消编辑以及初始化等常见方法，这里就不详细的做介绍了。

实现了问题组件的父类之后，接下来就看下如何实现一个具体的问题组件了。首先以文本问题组件为例，代码如下：

	@Component({
		inputs: ['question', 'isPublished'],
		outputs: ['delQuestionRequest'],
		selector: 'question-text',
		template:`
			<p>问答题</p>

			<template [ngIf] = "isPublished">
				<p>{{newQuestion.title}}</p>
				<input placeholder = "请输入问题的答案" [(ngModel)] = "newQuestion.answer">
			</template>

			<template [ngIf] = "!isPublished && isEdit">
				<input placeholder = "请输入问题" [(ngModel)] = "newQuestion.title" required>
				<button type = "button" (click) = "toSave()" class = "btn btn-default">保存</button>
				<button type = "button" (click) = "toCancel()" class= "btn btn-default">取消</button>
			</template>

			<template [ngIf] = "!isPublished && !isEdit">
				<p>{{newQuestion.title}}</p>
				<input placeholder = "请输入问题的答案" disabled = "disabled">
				<button type = "button" (click) = "toEdit()" class = "btn btn-default">编辑</button>
				<button type = "button" (click) = "toDelete()" class= "btn btn-default">删除</button>
			</template>
		`
	})

	export class QuestionTextCmp extends QuestionComponent{
	}

问题组件包含两个输入属性，question和isPublished。其中，question属性指的是传递给问题组件的具体问题，且如果该问题为新建时，它的值为空。isPublished属性标记该问题是否处于发布状态，由于问题的发布状态是由它所属的问卷的发布状态决定的，所以该属性将由父问卷组件传入。

除此之外，问题组件还包含一个输出属性delQuestionRequest，上文中我们已经介绍过，该属性主要是用来向父问卷组件传递删除事件的。

在页面的显示模板中，我们定义了问题控件可能处于的三种状态，分别是已发布状态、未发布情况下的编辑状态、未发布情况下的非编辑状态，且每种状态下的问题组件的展示形式如下：

1. 已发布状态：此时主要处于问卷回收状态，要求被调查者输入问题答案
2. 未发布情况下的编辑状态：问卷作者正在编辑该问题，编辑过程中，可以随时保存或者取消编辑问题
3. 未发布情况下的非编辑状态：问卷作者正在浏览该问题，浏览过程中，可以随时编辑或删除问题


##### 9.5.4 我的问卷

- 问卷列表组件（包含问卷列表项组件）：讲解问卷列表组件及问卷列表项组件的代码。
- 问卷详情组件 （包含问卷操作组件）：讲解问卷详情组件及问卷操作组件的代码。
- 问卷统计组件：简单的统计数据，说明下问卷统计组件的代码。

##### 9.5.5 总结

对我们整个组件开发做一个概括性论述，罗列下组件开发中涉及到的ng2的知识点。