# 5. 问卷管理

学习了用户管理功能之后，相信大家对Angular2组件的开发步骤有个进一步的了解。本章开始介绍问卷功能的开发。相比用户管理而言，问卷管理是更为复杂的功能，涉及更多的组件，也是整个问卷调查系统最核心的功能。为了简便起见，本章将主要针对问卷创建页面做详细的说明，其他相关页面可参考附录中的代码库。

## 5.1 组件树和数据建模

Angular2采用的是基于组件的开发模式，因此在正式开始代码编写之前，本节将首先对问卷管理特别是问卷创建功能涉及到的组件以及它们之间的关联关系做一个简单的说明。

### 5.1.2 组件树

在第二章中，我们介绍到了整个项目的组件树，这里针对问卷管理功能进一步细化，给出更为具体的组件树，如下图所示：

![MacDown tree](https://github.com/gf-rd/gf-angular2-book/blob/master/_images/ch3/5-1.png)

## 5.2 简单的问卷创建页面

Angular2中页面的开发都是从组件的创建开始的，首先我们来实现一个问卷创建的组件。

##### 9.5.4 创建问卷

创建问卷是整个问卷调查系统最核心的功能之一。该功能共有三大类组件构成，分别为问题组件、问卷组件和问卷大纲组件，接下来将逐一实现这三大类组件。

###### 问题组件

问题组件是构建问卷组件的基础。几乎所有类型的问题组件都会包括问题标题、问题答案和控件状态等属性，以及编辑、取消编辑、保存和删除等操作，本例中这样公共部分将被封装到一个父类中，具体类型的问题组件将继承自该父类。父类的定义如下：

	export class QuestionComponent implements OnInit {
		question:QuestionModel;
		newQuestion:QuestionModel;
		isEdit:boolean = false;
		isPublished:boolean = false;
		delQuesitonRequest: EventEmitter<any> = new EventEmitter();

		constructor() {
			this.newQuestion = new QuestionModel();
		}

		toEdit() {
			this.isEdit = true;
		}

		toSave() {
			this.question = this.newQuestion;
			this.isEdit = false;
		}

		toDelete() {
			this.delQuestionRequest.emit(this.question);
		}

		toCancel() {
			this.newQuestion = this.question;
			this.isEdit = false;
		}

		ngOnInit(): void {
			this.question == null ? this.isEdit = true :
				this.newQuestion = this.question;
		}
	}

在上面的问题组件类定义中，question和newQuestion分别代表编辑前和编辑后的问题。isEdit标记问题当前是否处于编辑状态，isPublished标记问题是否处于已发布状态。

需要的特别注意的是delQuestionRequest属性，它的类型是EventEmitter。删除一个问题，需要经过如下步骤：

1. 问题组件中触发删除操作(toDelete方法)
2. 删除事件由问题组件（子组件）传递给所对应的问卷组件（父组件）
3. 在问卷组件的维护的问题列表中将该问题删除

通过delQuestionRequest属性就可以起到在父组件中监听子组件事件的作用（参见2.4.2小节）。

除了问题组件类属性之外，我们还定义了几个组件类似编辑、保存、取消编辑以及初始化等常见方法，这里就不详细的做介绍了。

实现了问题组件的父类之后，接下来就看下如何实现一个具体的问题组件了。首先以文本问题组件为例，代码如下：

	@Component({
		inputs: ['question', 'isPublished'],
		outputs: ['delQuestionRequest'],
		selector: 'question-text',
		template:`
			<p>问答题</p>

			<template [ngIf] = "isPublished">
				<p>{{newQuestion.title}}</p>
				<input placeholder = "请输入问题的答案" [(ngModel)] = "newQuestion.answer" />
			</template>

			<template [ngIf] = "!isPublished && isEdit">
				<input placeholder = "请输入问题" [(ngModel)] = "newQuestion.title" required />
				<button type = "button" (click) = "toSave()" class = "btn btn-default">保存</button>
				<button type = "button" (click) = "toCancel()" class= "btn btn-default">取消</button>
			</template>

			<template [ngIf] = "!isPublished && !isEdit">
				<p>{{newQuestion.title}}</p>
				<input placeholder = "请输入问题的答案" disabled = "disabled" />
				<button type = "button" (click) = "toEdit()" class = "btn btn-default">编辑</button>
				<button type = "button" (click) = "toDelete()" class= "btn btn-default">删除</button>
			</template>
		`
	})

	export class QuestionTextCmp extends QuestionComponent{
	}

问题组件包含两个输入属性，question和isPublished。其中，question属性指的是传递给问题组件的具体问题，且如果该问题为新建时，它的值为空。isPublished属性标记该问题是否处于发布状态，由于问题的发布状态是由它所属的问卷的发布状态决定的，所以该属性将由父问卷组件传入。

除此之外，问题组件还包含一个输出属性delQuestionRequest，上文中我们已经介绍过，该属性主要是用来向父问卷组件传递删除事件的。

在页面的显示模板中，我们定义了问题控件可能处于的三种状态，分别是已发布状态、未发布情况下的编辑状态、未发布情况下的非编辑状态，且每种状态下的问题组件的展示形式如下：

1. 已发布状态：此时主要处于问卷回收状态，要求被调查者输入问题答案
2. 未发布情况下的编辑状态：问卷作者正在编辑该问题，编辑过程中，可以随时保存或者取消编辑问题
3. 未发布情况下的非编辑状态：问卷作者正在浏览该问题，浏览过程中，可以随时编辑或删除问题

分值问题组件和文本问题组件类似，代码如下：

	@Component({
		inputs: ['question', 'isPublished'],
		outputs: ['delQuestionRequest'],
		selector: 'question-score',
		template: `
			<p>分值题</p>

			<template [ngIf] = "isPublished">
				<p>{{newQuestion.title}}</p>
				<p class = "range-field">
					<label>分值：{{newQuestion.answer}}</label>
					<input type = "range" [(ngModel)] = "newQuestion.answer" min = "0" max = "100" />
				</p>
			</template>

			<template [ngIf] = "isPublished && isEdit">
				<input placeholder = "请输入问题" [(ngModel)] = "newQuestion.title" required />
				<button type = "button" (click) = "toSave()" class = "btn btn-default">保存</button>
				<button type = "button" (click) = "toCancel()" class= "btn btn-default">取消</button>
			</template>

			<template [ngIf] = "isPublished && !isEdit">
				<p>{{newQuestion.title}}</p>
				<p class = "range-field">
					<label>分值：50</label>
					<input type = "range" disabled = "disabled" value = "50" min = "0" max = "100" />
				</p>
				<button type = "button" (click) = "toEdit()" class = "btn btn-default">编辑</button>
				<button type = "button" (click) = "toDelete()" class= "btn btn-default">删除</button>
			</template>
		`
	})

	export class QuestionScoreCmp extends QuestionComponent {
	}

和文本问题组件及分值问题组件不同，单选问题组件和多选问题组件多出一个选择项功能。首先来看下单选问题组件的定义，代码如下：

	@Component({
		inputs: ['question', 'isPublished'],
		outputs: ['delQuestionRequest'],
		selector: 'question-radio',
		template: `
			<p>单选题</p>

			<template [ngIf] = "isPublished">
				<p>{{newQuestion.title}}</p>
				<p *ngFor = #option of newQuestion.options">
					<input value = "{{option.key}}" [(ng-model)] = "newQuestion.answer" name = "group1" type = "radio" id = "option{{option.key}}" />
					<label attr.for = "option{{option.key}}">{{option.value}}</label>
				</p>
			</template>

			<template [ngIf] = "!isPublished && isEdit">
				<input placeholder = "请输入问题" [(ngModel)] = "newQuestion.title" required />
				<div *ngFor = "#option of newQuestion.options">
					<div class = "row">
						<div class = "col s6">
							<input placeholder = "请填写选项" [(ngModel)] = "option.value" type = "text" />
						</div>
						<div class = "col s2">
							<span class="del-icon" (click) = "toDelOption($index)">X</span>
						</div>
					</div>
				</div>
				<button type = "button" (click) = "toSave()" class = "btn btn-default">保存</button>
				<button type = "button" (click) = "toAddOption()" class = "btn btn-default">添加选项</button>
				<button type = "button" (click) = "toCancel()" class = "btn btn-default">取消</button>
			</template>

			<template [ngIf] = "!isPublished && !isEdit">
				<p>{{newQuestion.title}}</p>
				<p *ngFor = "#option of newQuestion.options">
					<input name = "group1" disabled = "disabled" type = "radio" id = "option{{option.key}}" />
					<label attr.for = "option{{option.key}}">{{option.value}}</label>
				</p>
				<button type = "button" (click) = "toEdit()" class = "btn btn-default">编辑</button>
				<button type = "button" (click) = "toDelete()" class= "btn btn-default">删除</button>
			</template>
		`
	})

	export class QuestionRadioCmp extends QuestionComponent {
		key: number;

		toDelOption(index:number){
			if(this.newQuestion.options.length <= 2）{
				return;
			}

			this.newQuestion.options.slice(index, 1);
		}

		toAddOption(){
			this.newQuestion.options.push({key: this.key++, value:''});
		}

		ngOnInit(): void{
			super.ngOnInit();
			let options = this.newQuestion.options;
			if(!options || options.length == 0){
				options = [{
					key: 0,
					value:'选项1'
				}, {
					key: 1,
					value: '选项2'
				}];
			}

			this.key = options.length - 1;
		}
	}

单选问题组件中，类定义增加了一个数值类型的key属性，用来标识选项的唯一性ID。每增加一个选项，key的值就会加1。另外类中扩展了初始化函数ngOnInit。为了保证问题的可操作性，至少要有两个选项可供选择。所以，在初始化一个空的问题组件时，增加了两个初始选项，即例子中的选项1和选项2。最后，还要为key赋初值。

除了扩展初始化函数之外，单选组件中也增加了两个用来操作选项的函数，分别为删除选项函数（toDelOption）和添加选项函数（toAddOption），这两个函数的定义都比较简单，这里将不再赘述。

复选问题组件和单选问题组件的定义基本一致，不同之处主要在于，复选问题支持选中多个选项，所以答案类型为数组。代码如下：

	@Component({
		inputs: ['question', 'isPublished'],
		outputs: ['delQuestionRequest'],
		selector: 'question-radio',
		template: `
			<p>多选题</p>

			<template [ngIf] = "isPublished">
				<p>{{newQuestion.title}}</p>
				<input type = "hidden" name = "selected" [(ngModel)] = "newQuestion.answer.selected" />
				<p *ngFor = #option of newQuestion.options">
					<input name = "group1" type = "checkbox" id = "option{{option.key}}" (change) = "setSelectedValue($event.target.checked, option.value)" />
					<label attr.for = "option{{option.key}}">{{option.value}}</label>
				</p>
			</template>

			<template [ngIf] = "!isPublished && isEdit">
				<input placeholder = "请输入问题" [(ngModel)] = "newQuestion.title" required />
				<div *ngFor = "#option of newQuestion.options">
					<div class = "row">
						<div class = "col s6">
							<input placeholder = "请填写选项" [(ngModel)] = "option.value" type = "text" />
						</div>
						<div class = "col s2">
							<span class="del-icon" (click) = "toDelOption($index)">X</span>
						</div>
					</div>
				</div>
				<button type = "button" (click) = "toSave()" class = "btn btn-default">保存</button>
				<button type = "button" (click) = "toAddOption()" class = "btn btn-default">添加选项</button>
				<button type = "button" (click) = "toCancel()" class = "btn btn-default">取消</button>
			</template>

			<template [ngIf] = "!isPublished && !isEdit">
				<p>{{newQuestion.title}}</p>
				<p *ngFor = "#option of newQuestion.options">
					<input name = "group1" disabled = "disabled" type = "checkbox" id = "option{{option.key}}" />
					<label attr.for = "option{{option.key}}">{{option.value}}</label>
				</p>
				<button type = "button" (click) = "toEdit()" class = "btn btn-default">编辑</button>
				<button type = "button" (click) = "toDelete()" class= "btn btn-default">删除</button>
			</template>
		`
	})

	export class QuestionRadioCmp extends QuestionComponent {
		key: number;

		toDelOption(index:number){
			if(this.newQuestion.options.length <= 2）{
				return;
			}

			this.newQuestion.options.slice(index, 1);
		}

		toAddOption(){
			this.newQuestion.options.push({key: this.key++, value:''});
		}

		setSelectedValue(checked, value){
			let selected = this.newQuestion.answer.selected;
			let index:number = selected.indexOf(value);
			if(checked){
				if(index < 0){
					selected.push(value);
				}
			}else{
				inf(index > -1){
					selected.splice(index, 1);
				}
			}
		}

		ngOnInit(): void{
			super.ngOnInit();
			let options = this.newQuestion.options;
			if(!options || options.length == 0){
				options = [{
					key: 0,
					value:'选项1'
				}, {
					key: 1,
					value: '选项2'
				}];
			}

			if(!this.newQuestion.answer.selected){
				this.newQuestion.answer.selected = [];
			}

			this.key = options.length - 1;
		}
	}

在复选问题组件中，问题答案添加了一个数组类型selected，用来存储选中的选项。所以和单选问题组件不同的是，在初始化函数中，当问题的组件为空时，为答案的selected属性赋一个空的数组。

当点击复选框时，触发setSelectedValue方法并将$event.target.checked及复选框对应的value值作为参数传入，并且更新答案的selected属性值。控件的使用详情可参考3.5.2表单指令的复选框部分。

本节介绍了四种问题组件，接下来我们看下如何在问卷组件种使用这些组件。


##### 9.5.4 我的问卷

- 问卷列表组件（包含问卷列表项组件）：讲解问卷列表组件及问卷列表项组件的代码。
- 问卷详情组件 （包含问卷操作组件）：讲解问卷详情组件及问卷操作组件的代码。
- 问卷统计组件：简单的统计数据，说明下问卷统计组件的代码。

##### 9.5.5 总结

对我们整个组件开发做一个概括性论述，罗列下组件开发中涉及到的ng2的知识点。
